cd $( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

get_commit() {
  COMMIT=$(git rev-parse --verify --short HEAD)
  RETURN_CODE=$?
  export COMMIT
  return $RETURN_CODE
}

get_version() {
  # Version will be the most recent tag + "-dev" if working tree is dirty
  # e.g.: "1.0.1"" or "1.0.1-dev"
  VERSION=$(git describe --tags --dirty='-dev' 2> /dev/null)
  export VERSION
  return 0
}

# Remove previously downloaded dvm-helper binaries
if [ -e 'dvm-helper' ]; then
  rm dvm-helper
fi
if [ -e 'dvm-helper.exe' ]; then
  rm dvm-helper.exe
fi

# Use information about git repo to set the binary version and commit
get_commit
get_version

LDFLAGS="-X main.dvmCommit=${COMMIT} \
         -X main.dvmVersion=${VERSION}"

# Build ALL THE THINGS!
GOOS=windows GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o bin/dvm-helper-windows-amd64.exe
GOOS=windows GOARCH=386 go build -ldflags "${LDFLAGS}" -o bin/dvm-helper-windows-386.exe

GOOS=darwin GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o bin/dvm-helper-darwin-amd64
GOOS=darwin GOARCH=386 go build -ldflags "${LDFLAGS}" -o bin/dvm-helper-darwin-386

GOOS=linux GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o bin/dvm-helper-linux-amd64
GOOS=linux GOARCH=386 go build -ldflags "${LDFLAGS}" -o bin/dvm-helper-linux-386
